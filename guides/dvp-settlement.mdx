---
title: 'DvP 결제 가이드'
description: 'T+0 동시 결제 (Delivery versus Payment)'
---

# DvP 결제 가이드

이 가이드에서는 Pulse 네트워크의 DvP(Delivery versus Payment) 결제 방식을 설명합니다.

## DvP란?

**DvP(Delivery versus Payment)**는 증권 인도와 대금 지급이 동시에 이루어지는 결제 방식입니다.

<CardGroup cols={2}>
  <Card title="기존 결제 방식" icon="clock">
    - T+2 결제 (거래 후 2영업일)
    - 결제 리스크 존재
    - 중앙 기관 필요
  </Card>
  <Card title="Pulse DvP" icon="bolt">
    - T+0 결제 (즉시)
    - 원자적 교환 (Atomic Swap)
    - 결제 리스크 제거
  </Card>
</CardGroup>

---

## Atomic Swap 원리

Pulse의 DvP는 **Atomic Swap** 기술을 사용합니다. 두 전송이 모두 성공하거나 모두 실패합니다:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Atomic Swap 원리                                    │
│                                                                             │
│   [실행 전]                                      [실행 후]                   │
│                                                                             │
│   매도자 A          매수자 B                 매도자 A          매수자 B      │
│   ┌───────┐        ┌───────┐               ┌───────┐        ┌───────┐      │
│   │ST: 100│        │ST: 0  │               │ST: 0  │        │ST: 100│      │
│   │DT: 0  │        │DT: 1M │     ───▶      │DT: 1M │        │DT: 0  │      │
│   └───────┘        └───────┘               └───────┘        └───────┘      │
│                                                                             │
│                     단일 트랜잭션 내에서 동시 교환                            │
│                     실패 시 전체 롤백 (부분 실행 없음)                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

<Note>
  Atomic Swap은 스마트 컨트랙트 레벨에서 처리되므로, 한쪽만 실행되는 상황이 발생하지 않습니다.
</Note>

---

## ST와 DT

### Security Token (ST)

증권을 토큰화한 것:
- 투자계약증권, 수익증권, 채무증권 등
- 실물 증권의 권리를 표상
- KYC 등록된 주소만 보유 가능

### Digital Token (DT)

결제용 토큰:
- 원화와 1:1 페깅
- 결제 대금 지급에 사용
- KYC 등록 필수

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ST/DT 토큰 구조                                      │
│                                                                             │
│   ┌─────────────────────────────┐     ┌─────────────────────────────┐      │
│   │      Security Token (ST)     │     │      Digital Token (DT)     │      │
│   │                             │     │                             │      │
│   │  • 증권 토큰                 │     │  • 결제 토큰                 │      │
│   │  • 투자계약증권, 수익증권    │     │  • 원화 1:1 페깅             │      │
│   │  • decimals: 0              │     │  • decimals: 0 (원 단위)     │      │
│   │  • ERC-1400 기반            │     │  • ERC-1400 기반            │      │
│   └─────────────────────────────┘     └─────────────────────────────┘      │
│                    │                               │                        │
│                    └───────────── Swap ───────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## DvP 결제 플로우

### 1. 결제 준비

```javascript
// 매도자 정보
const seller = {
  address: '0xSeller...',
  stBalance: '100',    // 보유 ST
  dtBalance: '0'       // 보유 DT
};

// 매수자 정보
const buyer = {
  address: '0xBuyer...',
  stBalance: '0',      // 보유 ST
  dtBalance: '1000000' // 보유 DT (100만원)
};

// 거래 조건
const trade = {
  stToken: 'PULSE-ST-001',
  dtToken: 'PULSE-DT',
  quantity: '100',     // ST 100개
  pricePerST: 10000,   // 개당 1만원
  totalPrice: '1000000' // 총 100만원
};
```

### 2. Swap 가능 여부 확인

```javascript
async function checkDvPSettlement(seller, buyer, trade) {
  const checkResult = await fetch(
    'https://api.stopulse.co.kr/main/v1/swap/check',
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        stToken: trade.stToken,
        dtToken: trade.dtToken,
        stFrom: seller.address,
        stTo: buyer.address,
        stValue: trade.quantity,
        dtFrom: buyer.address,
        dtTo: seller.address,
        dtValue: trade.totalPrice
      })
    }
  );

  return await checkResult.json();
}

const check = await checkDvPSettlement(seller, buyer, trade);
console.log('Swap 가능:', check.swappable);
console.log('검증 결과:', check.checks);
```

### 응답 예시

```json
{
  "swappable": true,
  "checks": {
    "stSenderBalance": true,
    "stSenderKYC": true,
    "stReceiverKYC": true,
    "dtSenderBalance": true,
    "dtSenderKYC": true,
    "dtReceiverKYC": true
  }
}
```

### 3. DvP 결제 실행

```javascript
async function executeDvPSettlement(seller, buyer, trade) {
  const response = await fetch(
    'https://api.stopulse.co.kr/main/v1/swap',
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        stToken: trade.stToken,
        dtToken: trade.dtToken,
        stFrom: seller.address,    // ST 출발: 매도자
        stTo: buyer.address,       // ST 도착: 매수자
        stValue: trade.quantity,
        dtFrom: buyer.address,     // DT 출발: 매수자
        dtTo: seller.address,      // DT 도착: 매도자
        dtValue: trade.totalPrice
      })
    }
  );

  return await response.json();
}

const result = await executeDvPSettlement(seller, buyer, trade);
console.log('Transaction Hash:', result.transactionHash);
```

### 4. 결제 확인

```javascript
async function verifySettlement(txHash) {
  const response = await fetch(
    `https://api.stopulse.co.kr/main/v1/transactions/${txHash}`,
    {
      headers: { 'Authorization': `Bearer ${accessToken}` }
    }
  );

  const tx = await response.json();

  if (tx.status === 'confirmed') {
    console.log('DvP 결제 완료!');
    console.log('블록 번호:', tx.blockNumber);
    return true;
  }

  return false;
}
```

---

## 결제 실패 처리

### 실패 원인

| 실패 코드 | 원인 | 해결 방법 |
|----------|------|----------|
| `ST_SENDER_INSUFFICIENT_BALANCE` | 매도자 ST 부족 | 거래 수량 조정 |
| `DT_SENDER_INSUFFICIENT_BALANCE` | 매수자 DT 부족 | 결제 금액 확인 |
| `KYC_NOT_REGISTERED` | KYC 미등록 | KYC 등록 후 재시도 |
| `TOKENS_LOCKED` | 토큰 잠금 상태 | 잠금 해제 후 재시도 |

### 실패 시 처리

```javascript
async function handleSettlementFailure(trade, reason) {
  // 1. 주문 상태 업데이트
  await updateOrderStatus(trade.orderId, 'settlement_failed', reason);

  // 2. 고객 알림
  await notifyCustomer(trade.sellerId, `결제 실패: ${reason}`);
  await notifyCustomer(trade.buyerId, `결제 실패: ${reason}`);

  // 3. 재시도 또는 취소 처리
  if (isRetryable(reason)) {
    await scheduleRetry(trade);
  } else {
    await cancelTrade(trade);
  }
}
```

---

## 부분 체결 처리

대량 거래의 경우 부분 체결이 필요할 수 있습니다:

```javascript
async function partialSettlement(order, availableQuantity) {
  // 1. 부분 체결 수량 계산
  const partialTrade = {
    ...order,
    quantity: availableQuantity,
    totalPrice: (BigInt(order.pricePerST) * BigInt(availableQuantity)).toString()
  };

  // 2. 부분 결제 실행
  const result = await executeDvPSettlement(
    order.seller,
    order.buyer,
    partialTrade
  );

  // 3. 잔여 주문 처리
  const remainingQuantity = BigInt(order.quantity) - BigInt(availableQuantity);
  if (remainingQuantity > 0n) {
    await createRemainingOrder(order, remainingQuantity.toString());
  }

  return result;
}
```

---

## 멀티 Swap (N:N 거래)

여러 매도자와 매수자 간 동시 결제:

```javascript
// 복수 거래 일괄 처리
async function batchSettlement(trades) {
  const results = [];

  for (const trade of trades) {
    // 각 거래별 Swap 실행
    // 참고: 현재 API는 1:1 Swap만 지원
    // 멀티 Swap은 순차 처리
    const result = await executeDvPSettlement(
      trade.seller,
      trade.buyer,
      trade
    );
    results.push(result);
  }

  return results;
}
```

---

## DvP 장점

<AccordionGroup>
  <Accordion title="결제 리스크 제거">
    원자적 교환으로 한쪽만 실행되는 상황이 발생하지 않습니다.
    증권은 받았는데 대금을 못 받는 상황이 불가능합니다.
  </Accordion>
  <Accordion title="T+0 즉시 결제">
    거래 체결 즉시 결제가 완료됩니다.
    기존 T+2 대비 결제 시간 대폭 단축됩니다.
  </Accordion>
  <Accordion title="운영 효율성">
    중앙 청산 기관 없이 P2P 결제가 가능합니다.
    결제 실패 처리 비용이 감소합니다.
  </Accordion>
  <Accordion title="투명성">
    모든 결제 내역이 블록체인에 기록됩니다.
    실시간 감사 추적이 가능합니다.
  </Accordion>
</AccordionGroup>

---

## 관련 API

<CardGroup cols={2}>
  <Card title="Swap API" icon="right-left" href="/api-reference/operator-swap">
    DvP 결제 실행
  </Card>
  <Card title="Token Holder API" icon="wallet" href="/api-reference/token-holder">
    잔액 확인
  </Card>
  <Card title="Transaction API" icon="receipt" href="/api-reference/transaction">
    결제 내역 조회
  </Card>
  <Card title="Lock API" icon="lock" href="/api-reference/token-lock">
    토큰 잠금 관리
  </Card>
</CardGroup>
