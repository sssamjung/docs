---
title: 'Swap API'
description: 'ST/DT 토큰 스왑 (DvP 결제)'
---

# Swap API

Swap API는 Security Token(ST)과 Digital Token(DT) 간의 원자적 교환(Atomic Swap)을 제공합니다. 이를 통해 **T+0 DvP(Delivery versus Payment)** 결제가 가능합니다.

<Info>
  DvP(Delivery versus Payment)는 증권 인도와 대금 지급이 동시에 이루어지는 결제 방식으로, 결제 리스크를 최소화합니다.
</Info>

## Swap 개념

```
┌──────────────────────────────────────────────────────────────────┐
│                        Atomic Swap                                │
│                                                                   │
│   매도자 (A)              Swap Contract             매수자 (B)    │
│   ┌─────────┐          ┌─────────────┐          ┌─────────┐      │
│   │ ST 100  │─────────▶│   Atomic    │◀─────────│ DT 100  │      │
│   │ DT 0    │◀─────────│   Swap      │─────────▶│ ST 0    │      │
│   └─────────┘          └─────────────┘          └─────────┘      │
│                                                                   │
│   결과: A = ST 0, DT 100 / B = ST 100, DT 0                      │
└──────────────────────────────────────────────────────────────────┘
```

---

## Swap 실행

ST와 DT를 원자적으로 교환합니다. 두 전송이 모두 성공하거나 모두 실패합니다.

### Request

```bash
POST /main/v1/swap
```

### Body Parameters

<ParamField body="stToken" type="string" required>
  Security Token 심볼
</ParamField>

<ParamField body="dtToken" type="string" required>
  Digital Token 심볼
</ParamField>

<ParamField body="stFrom" type="string" required>
  ST 송신자 (매도자) 주소
</ParamField>

<ParamField body="stTo" type="string" required>
  ST 수신자 (매수자) 주소
</ParamField>

<ParamField body="stValue" type="string" required>
  ST 전송 수량
</ParamField>

<ParamField body="dtFrom" type="string" required>
  DT 송신자 (매수자) 주소
</ParamField>

<ParamField body="dtTo" type="string" required>
  DT 수신자 (매도자) 주소
</ParamField>

<ParamField body="dtValue" type="string" required>
  DT 전송 수량
</ParamField>

<ParamField body="partition" type="string">
  파티션 ID (선택)
</ParamField>

### Example

<CodeGroup>

```bash cURL
curl -X POST "https://api.stopulse.co.kr/main/v1/swap" \
  -H "Authorization: Bearer {access_token}" \
  -H "Content-Type: application/json" \
  -d '{
    "stToken": "PULSE-ST-001",
    "dtToken": "PULSE-DT-001",
    "stFrom": "0xSeller...",
    "stTo": "0xBuyer...",
    "stValue": "100",
    "dtFrom": "0xBuyer...",
    "dtTo": "0xSeller...",
    "dtValue": "1000000"
  }'
```

```javascript JavaScript
const response = await fetch('https://api.stopulse.co.kr/main/v1/swap', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer {access_token}',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    stToken: 'PULSE-ST-001',
    dtToken: 'PULSE-DT-001',
    stFrom: '0xSeller...',   // 매도자: ST 보유
    stTo: '0xBuyer...',      // 매수자: ST 수령
    stValue: '100',
    dtFrom: '0xBuyer...',    // 매수자: DT 보유
    dtTo: '0xSeller...',     // 매도자: DT 수령
    dtValue: '1000000'       // 결제 금액 (원 단위)
  })
});
```

```python Python
import requests

url = "https://api.stopulse.co.kr/main/v1/swap"
headers = {
    "Authorization": "Bearer {access_token}",
    "Content-Type": "application/json"
}
data = {
    "stToken": "PULSE-ST-001",
    "dtToken": "PULSE-DT-001",
    "stFrom": "0xSeller...",
    "stTo": "0xBuyer...",
    "stValue": "100",
    "dtFrom": "0xBuyer...",
    "dtTo": "0xSeller...",
    "dtValue": "1000000"
}

response = requests.post(url, headers=headers, json=data)
```

</CodeGroup>

### Response

```json 200
{
  "transactionHash": "0xabc123...",
  "requestId": "swap-123456",
  "stToken": "PULSE-ST-001",
  "dtToken": "PULSE-DT-001",
  "stTransfer": {
    "from": "0xSeller...",
    "to": "0xBuyer...",
    "value": "100"
  },
  "dtTransfer": {
    "from": "0xBuyer...",
    "to": "0xSeller...",
    "value": "1000000"
  }
}
```

---

## Swap 가능 여부 확인

Swap 실행 전 가능 여부를 확인합니다.

### Request

```bash
POST /main/v1/swap/check
```

### Body Parameters

Swap 실행과 동일한 파라미터를 사용합니다.

### Response

```json 200
{
  "swappable": true,
  "stToken": "PULSE-ST-001",
  "dtToken": "PULSE-DT-001",
  "checks": {
    "stSenderBalance": true,
    "stSenderKYC": true,
    "stReceiverKYC": true,
    "dtSenderBalance": true,
    "dtSenderKYC": true,
    "dtReceiverKYC": true
  }
}
```

Swap 불가 시:

```json 200
{
  "swappable": false,
  "reason": "ST_SENDER_INSUFFICIENT_BALANCE",
  "checks": {
    "stSenderBalance": false,
    "stSenderKYC": true,
    "stReceiverKYC": true,
    "dtSenderBalance": true,
    "dtSenderKYC": true,
    "dtReceiverKYC": true
  }
}
```

---

## 장외거래 Swap 플로우

장외거래중개업자를 통한 Swap 처리 플로우:

```
┌─────────────┐    ①주문    ┌──────────────────┐    ①주문    ┌─────────────┐
│   매도자    │────────────▶│  장외거래중개업자  │◀────────────│   매수자    │
│  (ST 보유)  │             │    (증권사 C)     │             │  (DT 보유)  │
└─────────────┘             └────────┬─────────┘             └─────────────┘
                                     │
                            ②호가 매칭 (체결)
                                     │
                                     ▼
                            ┌─────────────────┐
                            │   Swap API 호출  │
                            └────────┬────────┘
                                     │
                            ③Atomic Swap 실행
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │   Pulse Blockchain    │
                         │  ┌─────────────────┐  │
                         │  │  ST: 매도→매수   │  │
                         │  │  DT: 매수→매도   │  │
                         │  └─────────────────┘  │
                         └───────────────────────┘
```

### 장외거래 API 통합 예시

```javascript
// 장외거래중개업자 시스템
class OTCBroker {
  async processMatchedOrder(sellOrder, buyOrder) {
    // 1. Swap 가능 여부 확인
    const checkResult = await this.pulseAPI.checkSwap({
      stToken: sellOrder.token,
      dtToken: 'PULSE-DT',
      stFrom: sellOrder.seller,
      stTo: buyOrder.buyer,
      stValue: sellOrder.quantity,
      dtFrom: buyOrder.buyer,
      dtTo: sellOrder.seller,
      dtValue: buyOrder.totalPrice
    });

    if (!checkResult.swappable) {
      throw new Error(`Swap 불가: ${checkResult.reason}`);
    }

    // 2. Swap 실행 (T+0 DvP)
    const swapResult = await this.pulseAPI.executeSwap({
      stToken: sellOrder.token,
      dtToken: 'PULSE-DT',
      stFrom: sellOrder.seller,
      stTo: buyOrder.buyer,
      stValue: sellOrder.quantity,
      dtFrom: buyOrder.buyer,
      dtTo: sellOrder.seller,
      dtValue: buyOrder.totalPrice
    });

    return swapResult;
  }
}
```

---

## 에러 응답

| HTTP Status | 에러 코드 | 설명 |
|-------------|----------|------|
| 400 | `ST_SENDER_INSUFFICIENT_BALANCE` | ST 송신자 잔액 부족 |
| 400 | `DT_SENDER_INSUFFICIENT_BALANCE` | DT 송신자 잔액 부족 |
| 400 | `KYC_NOT_REGISTERED` | KYC 미등록 주소 포함 |
| 400 | `INVALID_TOKEN` | 유효하지 않은 토큰 |
| 403 | `NOT_OPERATOR` | Operator 권한 없음 |
| 500 | `SWAP_FAILED` | Swap 실행 실패 (롤백됨) |

<Warning>
  Swap 실행 중 오류 발생 시 모든 전송이 자동으로 롤백됩니다. 부분 실행은 발생하지 않습니다.
</Warning>
